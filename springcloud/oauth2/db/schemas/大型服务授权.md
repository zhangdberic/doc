clientDetails和userDetails的表结构，就使用oauth2的标准表结构，这里不再多说了，
关键在**用户权限(用户授权)表**的设计和不同服务实例的**资源服务配置类**的设计。  

资源服务配置类设计  
----  


一个大型的微服务群，是由多个jvm实例组成的，这里的jvm实例可以理解为一个jar进程或者是docker，一个jvm实例内部可以只包括一个服务，也可以包括多个服务。  
不管内部是多个服务还是一个服务，都要配置一个服务资源类(授权访问类)，需要继承ResourceServerConfigurerAdapter类。  
为了设计一个通用的**服务资源类**，把资源服务类配置分成不同的层次。  

1.无需要认证直接访问服务(公共服务)。  
理解为不需要认证直接就可以调用服务。  

2.需要认证才能访问的服务。  
只要认证(登录)后就可以访问服务。

3.需要授权访问的服务。  
不但需要认证(登录)，而且这个认证(用户)还需要由可以访问服务的权限。

```java
    @Override
    public void configure(HttpSecurity http) throws Exception {
      // 无需要认证直接访问服务(公共服务)
      http.authorizeRequests().antMatchers("/xxxx/xxx1","/xxxx/xxx2").permitAll();
      // 需要认证才能访问的服务
      http.authorizeRequests().anyRequest().authenticated();
      // 需要授权访问的服务
      http.authorizeRequests().antMatchers("/oauth/remove_token").hasAuthority("123");
      http.authorizeRequests().antMatchers("/oauth/remove_token").access("hasIpAddress('192.168.5.31')");
    }
```

用户授权相关表设计  
====  

权限表设计
oauth2_authority

| authority_id | name     | app       | method | url_ant_patterns | access_spel                  |
| ------------ | -------- | --------- | ------ | ---------------- | ---------------------------- |
| 1            | 增加数据 | dmservice | post   | /data/add        | null                         |
| 2            | 查看数据 | dmservice | *      | /data/*          | null                         |
| 3            | 删除数据 | dmservice | post   | /data/delete     | hasIpAddress('192.168.5.31') |

authority_id为表序号，唯一序列，权限码，对应hasAuthority(authority_id)。  
name对相关的记录命名，描述自动。  
app为对应的应用，这个权限配置隶属于那个应用，不同的应用启动会加载不同的权限规则。  
method限制请求的http_method，对应antMatchers(method)。  
url_ant_patterns匹配的url，对应antMatchers(url_ant_patterns)。  
access_spel使用spring表达式匹配，对应access("hasIpAddress(access_spel)")  

我们重新再来看上面的HttpSecurity规则设定，在应用或服务启动的时候，加载权限表数据，根据规则来创建HttpSecurity对象。  

例如：启动的应用是一个服务dmservice  

加载权限数据  
select * from oauth2_authority where app=dmservice  

第一条记录对应的规则如下：  
http.authorizeRequests().antMatchers(HttpMethod.POST).antMatchers("/data/add").hasAuthority("1");  
第二条记录对应的规则如下：  
http.authorizeRequests().antMatchers("/data/\*").hasAuthority("2");  
第三条记录对应的规则如下：
http.authorizeRequests().antMatchers(HttpMethod.POST).antMatchers("/data/delete").hasAuthority("3").
antMatchers("/data/delete").access("hasIpAddress('192.168.5.31')");  














